<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Shop - VideoShop</title>
  
  <!-- Google Fonts - YouTube uses Roboto -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <!-- CSS file (same as your main page) -->
  <link rel="stylesheet" href="/css/style.css">
  
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  
  <style>
    /* Additional Shop-specific styles */
    .shop-header {
      background: linear-gradient(135deg, var(--premium-gold), var(--warm-bronze));
      color: #000;
      padding: 40px;
      border-radius: 16px;
      margin-bottom: 32px;
      text-align: center;
    }

    .shop-header h1 {
      font-size: 2.5rem;
      margin-bottom: 16px;
      font-weight: 700;
    }

    .shop-header p {
      font-size: 1.2rem;
      opacity: 0.8;
    }

    /* Filter Bar */
    .filter-bar {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-group label {
      font-weight: 500;
      color: var(--text-secondary);
    }

    .filter-group select,
    .filter-group input {
      background: var(--bg-primary);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-color);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .sort-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .sort-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-color);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .sort-btn.active {
      background: var(--premium-gold);
      color: #000;
    }

    /* Bulk Discount Calculator */
    .bulk-calculator {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      border: 2px solid var(--premium-gold);
    }

    .quantity-slider {
      width: 100%;
      margin: 16px 0;
      accent-color: var(--premium-gold);
    }

    .discount-display {
      background: var(--premium-gold);
      color: #000;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      margin-top: 16px;
    }

    /* Product Comparison */
    .compare-checkbox-container {
      position: absolute;
      top: 8px;
      left: 8px;
      z-index: 10;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 4px;
      padding: 4px;
    }

    .compare-checkbox {
      width: 20px;
      height: 20px;
      accent-color: var(--premium-gold);
    }

    .compare-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #000000;
      border-top: 2px solid var(--premium-gold);
      padding: 16px;
      display: none;
      z-index: 1000;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
    }

    .compare-bar.active {
      display: flex;
    }

    .compare-items {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .compare-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 12px;
      border-radius: 8px;
    }

    .compare-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
    }

    /* Comparison Modal */
    .comparison-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.98);
      display: none;
      z-index: 9999;
      overflow-y: auto;
    }

    .comparison-modal.active {
      display: block;
    }

    .comparison-content {
      background: var(--bg-secondary);
      border-radius: 16px;
      width: 90%;
      max-width: 1200px;
      margin: 20px auto;
      position: relative;
    }

    .comparison-header {
      padding: 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .comparison-table {
      width: 100%;
      border-collapse: collapse;
    }

    .comparison-table th,
    .comparison-table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .comparison-table th {
      background: rgba(255, 215, 0, 0.1);
      font-weight: 600;
      color: var(--premium-gold);
    }

    .product-column {
      text-align: center;
      vertical-align: top;
    }

    .product-column img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .feature-label {
      font-weight: 600;
      color: var(--text-color);
      width: 200px;
    }

    .winner-badge {
      background: var(--premium-gold);
      color: #000;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 8px;
    }

/* Mobile hamburger menu fixes */
@media (max-width: 768px) {
  .container {
    margin-left: 0;
  }
  
  .sidebar {
    position: fixed;
    left: -60px;
    top: 0;
    height: 100vh;
    width: 60px;
    background: var(--bg-color);
    z-index: 1001;
    transition: left 0.3s ease;
    overflow-y: auto;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
  }

  .sidebar.mobile-open {
    left: 0;
    width: 60px;
  }
  
  .sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: none;
  }
  
  .sidebar-overlay.active {
    display: block;
  }
  
  .hamburger-menu {
    display: flex !important;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    z-index: 1002;
  }
  
  .filter-bar {
    flex-direction: column;
    align-items: stretch;
  }
  
  .sort-buttons {
    margin-left: 0;
    justify-content: center;
  }

  .bulk-calculator {
    text-align: center;
  }
}
      
    /* Loading animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  
  <!-- Header (same as main page) -->
  <header>
    <div class="hamburger-menu" id="hamburger-menu">
      <div class="hamburger-line"></div>
      <div class="hamburger-line"></div>
      <div class="hamburger-line"></div>
    </div>
    <a href="/" class="logo">Video<span>Shop</span></a>
    
    <div class="search-bar">
      <input type="text" placeholder="Search products..." id="search-input">
      <button onclick="searchProducts()">üîç</button>
    </div>
    
    <div class="user-actions">
      <button id="upload-btn">Upload</button>
      <a href="#" class="sign-in" onclick="openModal('login-modal')">Sign In</a>
    </div>
  </header>
  
  <!-- Sidebar (same as main page) -->
  <nav class="sidebar">
    <a href="/" class="sidebar-item">
      <span class="sidebar-icon">üè†</span>
      <span class="sidebar-text">Home</span>
    </a>
    <a href="/trending" class="sidebar-item">
      <span class="sidebar-icon">üî•</span>
      <span class="sidebar-text">Trending</span>
    </a>
    <a href="/subscriptions" class="sidebar-item">
      <span class="sidebar-icon">üìã</span>
      <span class="sidebar-text">Subscriptions</span>
    </a>
    <a href="/shop" class="sidebar-item active">
      <span class="sidebar-icon">üõí</span>
      <span class="sidebar-text">Shop</span>
    </a>
    <a href="/library" class="sidebar-item">
      <span class="sidebar-icon">üìö</span>
      <span class="sidebar-text">Library</span>
    </a>
    <a href="/history" class="sidebar-item">
      <span class="sidebar-icon">‚è±Ô∏è</span>
      <span class="sidebar-text">History</span>
    </a>
    <a href="/your-videos" class="sidebar-item">
      <span class="sidebar-icon">‚èØÔ∏è</span>
      <span class="sidebar-text">Your Videos</span>
    </a>
    <a href="/watch-later" class="sidebar-item">
      <span class="sidebar-icon">‚è∞</span>
      <span class="sidebar-text">Watch Later</span>
    </a>
    <a href="/liked-videos" class="sidebar-item">
      <span class="sidebar-icon">üëç</span>
      <span class="sidebar-text">Liked Videos</span>
    </a>
  </nav>
  
  <!-- Main Container -->
  <div class="container">
    <div class="main-content">
      
      <!-- Shop Header with Bulk Calculator -->
      <div style="display: flex; gap: 24px; margin-bottom: 4px; align-items: flex-start;">
        <div class="shop-header" style="flex: 1; margin-bottom: 0;">
          <h1>üõçÔ∏è Smart Shop</h1>
          <p>AI-powered shopping with real-time trending products from social media</p>
        </div>
        <div style="flex: 0 0 320px; margin-bottom: 0; padding: 12px; margin-top: 0; max-height: 200px; background: linear-gradient(135deg, var(--premium-gold), var(--warm-bronze)); border-radius: 12px;">
          <h4 style="margin: 0 0 8px 0; font-size: 1.1rem; color: #000; font-weight: 700;">üí∞ Bulk Discounts</h4>
          <p style="margin: 0 0 12px 0; font-size: 0.85rem; color: rgba(0,0,0,0.8);">Auto-applied at checkout</p>
          <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
            <div style="flex: 1;">
              <label style="font-size: 0.9rem; color: #000; font-weight: 600;">Qty:</label>
              <input type="range" min="1" max="20" value="1" id="bulk-quantity" oninput="updateBulkDiscount()" style="width: 100%; accent-color: #000;">
              <span id="quantity-display" style="color: #000; font-weight: 700;">1</span>
            </div>
            <div style="width: 70px;">
              <label style="font-size: 0.9rem; color: #000; font-weight: 600;">Price:</label>
              <input type="number" id="base-price" value="28" step="0.01" onchange="updateBulkDiscount()" style="width: 100%; padding: 8px; border-radius: 6px; background: rgba(255,255,255,0.95); color: #000; font-family: 'Roboto', sans-serif; font-weight: 700; font-size: 1rem; text-align: center; border: 2px solid rgba(0,0,0,0.2); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
            </div>
          </div>
          <div style="background: rgba(0,0,0,0.9); color: var(--premium-gold); padding: 8px 12px; border-radius: 8px; text-align: center; font-weight: 700; margin-bottom: 10px; word-wrap: break-word; max-width: 100%; box-sizing: border-box; max-height: 50px; overflow: hidden; line-height: 1.2; font-size: 0.85rem;" id="discount-display">
            1 item = $28 (No discount)
          </div>
          <div style="font-size: 0.9rem; color: var(--premium-gold); line-height: 1.4; font-weight: 600; margin-top: 45px;">
            <div>üéØ 3+ items: 5% off </div>
            <div>üéØ 6+ items: 10% off </div>
            <div>üéØ 12+ items: 20% off </div>
          </div>
        </div>
      </div>
      
      <!-- Filter Bar -->
      <div class="filter-bar" style="margin-bottom: 8px;">
        <div class="filter-group">
          <label>Price Range:</label>
          <select id="price-filter" onchange="applyFilters()">
            <option value="">Any Price</option>
            <option value="0-25">Under $25</option>
            <option value="25-50">$25 - $50</option>
            <option value="50-100">$50 - $100</option>
            <option value="100+">$100+</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Supplier:</label>
          <select id="supplier-filter" onchange="applyFilters()">
            <option value="">All Suppliers</option>
            <option value="cjdropshipping">CJ Dropshipping</option>
          </select>
        </div>
        <div class="sort-buttons">
          <button class="sort-btn active" onclick="sortProducts('trending')">üî• Trending</button>
          <button class="sort-btn" onclick="sortProducts('price-low')">üí∞ Price: Low</button>
          <button class="sort-btn" onclick="sortProducts('price-high')">üíé Price: High</button>
          <button class="sort-btn" onclick="sortProducts('newest')">‚ö° Newest</button>
        </div>
      </div>
      
      <!-- AI Assistant -->
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; margin-bottom: 8px; overflow: hidden;">
        <div style="padding: 14px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleTrendingRadar()">
          <div>
            <h3 style="color: white; font-size: 1.3rem; margin: 0;">ü§ñ AI Shopping Assistant</h3>
            <p style="color: rgba(255, 255, 255, 0.9); margin: 2px 0 0 0; font-size: 0.85rem;">Smart product discovery powered by social data</p>
          </div>
          <div style="color: white; font-size: 1.2rem;" id="radar-toggle-icon">‚ñº</div>
        </div>
        <div id="trending-radar-content" style="display: none; padding: 0 20px 20px 20px;">
          <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
            <button onclick="filterTrendingProducts('social')" id="social-btn" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 600;">üéØ Social Shopping Assistant</button>
            <button onclick="filterTrendingProducts('viral')" id="viral-btn" style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); border: 2px solid rgba(255,255,255,0.2); padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 600;">üöÄ Viral Product Scanner</button>
            <button onclick="filterTrendingProducts('smart')" id="smart-btn" style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); border: 2px solid rgba(255,255,255,0.2); padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚ö° Smart Product Feed</button>
          </div>
          <div class="product-grid" id="trending-radar-results">
            <div style="text-align: center; padding: 24px; color: rgba(255, 255, 255, 0.8);">
              <div style="font-size: 1.6rem; margin-bottom: 8px;">ü§ñ</div>
              <p>Click a filter above to discover products</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Products Header -->
      <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px;">
        <h3 style="font-size: 1.7rem; font-weight: 600; color: var(--text-color); margin: 0; margin-left: 20px;">üõçÔ∏è All Products</h3>
        <span style="background: var(--premium-gold); color: #000; padding: 5px 14px; border-radius: 14px; font-size: 0.8rem; font-weight: 600;" id="product-count">Loading...</span>
      </div>
      
      <!-- Products Grid -->
      <div class="product-grid" id="all-products">
        <div class="loading-spinner">
          <div style="border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--premium-gold); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
          Loading products...
        </div>
      </div>
      
    </div>
  </div>
  
  <script>
  // TRENDING RADAR REAL IMPLEMENTATION
  
  let currentRadarFilter = null;
  
  function toggleTrendingRadar() {
    const content = document.getElementById('trending-radar-content');
    const icon = document.getElementById('radar-toggle-icon');
    
    if (content.style.display === 'none') {
      content.style.display = 'block';
      icon.textContent = '‚ñ≤';
      icon.style.transform = 'rotate(180deg)';
    } else {
      content.style.display = 'none';
      icon.textContent = '‚ñº';
      icon.style.transform = 'rotate(0deg)';
    }
  }
  
  async function filterTrendingProducts(filterType) {
    console.log(`üîç Filtering trending products: ${filterType}`);
    
    // Update button states
    document.querySelectorAll('.radar-filter-btn').forEach(btn => {
      btn.style.background = 'rgba(255,255,255,0.1)';
      btn.style.color = 'rgba(255,255,255,0.8)';
      btn.style.border = '2px solid rgba(255,255,255,0.2)';
    });
    
    const activeBtn = document.getElementById(`${filterType}-btn`);
    activeBtn.style.background = 'rgba(255,255,255,0.2)';
    activeBtn.style.color = 'white';
    activeBtn.style.border = '2px solid rgba(255,255,255,0.4)';
    
    currentRadarFilter = filterType;
    
    // Show loading
    const resultsContainer = document.getElementById('trending-radar-results');
    resultsContainer.innerHTML = `
      <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.8);">
        <div style="border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
        <p>Scanning for ${getFilterDisplayName(filterType)} products...</p>
      </div>
    `;
    
    try {
      let apiUrl = `/api/automation/products/${filterType}`; // Uses your REAL routes
      
      console.log(`üì° Fetching from: ${apiUrl}`);
      
      const response = await fetch(apiUrl);
      const data = await response.json();
      
      if (data.success && data.products) {
        console.log(`‚úÖ Found ${data.products.length} products for ${filterType}`);
        
        renderTrendingResults(data.products, filterType);
        
      } else {
        console.error('‚ùå Failed to fetch trending products:', data);
        showTrendingError('Failed to load trending products');
      }
      
    } catch (error) {
      console.error('üí• Error fetching trending products:', error);
      showTrendingError('Error connecting to server');
    }
  }

  // UPDATE getTrendingMetrics to show REAL data:
  function getTrendingMetrics(product, filterType) {
    switch (filterType) {
      case 'social':
        const comments = product.communityEngagement?.comments || 0;
        const upvotes = product.communityEngagement?.upvotes || 0;
        return `üéØ ${comments} comments ‚Ä¢ ${upvotes} upvotes | ${product.subreddit || 'Reddit'}`;
      case 'viral':
        const viralRank = product.viralMetrics?.viralRank || 0;
        return `üöÄ Viral Rank: ${viralRank} | Engagement: ${product.viralMetrics?.redditEngagement || 0}`;
      case 'smart':
        const profit = product.smartScore?.profit || 0;
        const quality = product.smartScore?.qualityScore || 0;
        return `‚ö° $${profit} profit ‚Ä¢ Quality: ${quality}/100`;
      default:
        return `üìç ${product.subreddit || 'Featured'}`;
    }
  }
  
  function renderTrendingResults(products, filterType) {
    const resultsContainer = document.getElementById('trending-radar-results');
    
    if (products.length === 0) {
      resultsContainer.innerHTML = `
        <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.8);">
          <div style="font-size: 2rem; margin-bottom: 16px;">üòï</div>
          <p>No ${getFilterDisplayName(filterType)} products found</p>
          <p style="font-size: 0.9rem; opacity: 0.7;">Try running the automation pipeline to discover more products</p>
        </div>
      `;
      return;
    }
    
    const html = products.map(product => {
      const badge = getTrendingBadge(product, filterType);
      const metrics = getTrendingMetrics(product, filterType);
      
      return `
        <div class="product-card" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); position: relative;">
          ${badge}
          
          <div class="product-image" onclick="openProductModal('${product.id}')" style="cursor: pointer;">
            <img src="${product.imageUrl || 'https://via.placeholder.com/250x200?text=Product'}" 
                 alt="${product.name}" 
                 style="width: 100%; height: 200px; object-fit: cover;">
          </div>
          
          <div class="product-info">
            <div class="product-name" style="color: white; font-weight: 600;">${product.name}</div>
            <div class="product-price" style="color: var(--premium-gold); font-size: 1.2rem; font-weight: 700;">$${parseFloat(product.price).toFixed(2)}</div>
            <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 8px 0;">
              ${metrics}
            </div>
            <button class="add-to-cart-btn" onclick="addToCart('${product.id}')" style="background: white; color: #000; margin-top: 8px; width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
              üõí Add to Cart
            </button>
          </div>
        </div>
      `;
    }).join('');
    
    resultsContainer.innerHTML = html;
  }
  
  function getTrendingBadge(product, filterType) {
    switch (filterType) {
      case 'social':
        return '<div style="position: absolute; top: 8px; left: 8px; background: #44ff44; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; z-index: 10;">üéØ COMMUNITY</div>';
      case 'viral':
        if ((product.trendingScore || 0) > 80) return '<div style="position: absolute; top: 8px; left: 8px; background: #ff4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; z-index: 10;">üöÄ VIRAL</div>';
        break;
      case 'smart':
        return '<div style="position: absolute; top: 8px; left: 8px; background: #4444ff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; z-index: 10;">‚ö° SMART</div>';
    }
    return '';
  }
  
  function getFilterDisplayName(filterType) {
    switch (filterType) {
      case 'social': return 'community products';
      case 'viral': return 'viral products';
      case 'smart': return 'curated products';
      default: return filterType;
    }
  }
  
  function showTrendingError(message) {
    const resultsContainer = document.getElementById('trending-radar-results');
    resultsContainer.innerHTML = `
      <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.8);">
        <div style="font-size: 2rem; margin-bottom: 16px;">‚ö†Ô∏è</div>
        <p>${message}</p>
      </div>
    `;
  }
  
  </script>
  
  <!-- UPDATED CSS FOR 3-COLUMN GRID -->
  <style>
    /* Update product grid to 3 columns with better proportions */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 100px;
    }
    
    /* Ensure 3 columns on larger screens */
    @media (min-width: 1200px) {
      .product-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    /* 2 columns on medium screens */
    @media (max-width: 1199px) and (min-width: 768px) {
      .product-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* 1 column on mobile */
    @media (max-width: 767px) {
      .product-grid {
        grid-template-columns: 1fr;
      }
      
      /* Stack filter bar and calculator on mobile */
      .filter-bar {
        flex-direction: column !important;
      }
      
      .bulk-calculator {
        flex: 1 !important;
        margin-top: 16px;
      }
    }
    
    /* Fix product image aspect ratio */
    .product-image {
      height: 220px;
      overflow: hidden;
    }
    
    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    /* Better card proportions */
    .product-card {
      background: var(--bg-secondary);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      display: flex;
      flex-direction: column;
    }
    
    .product-info {
      padding: 16px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    
    .product-name {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 1rem;
      line-height: 1.3;
      height: 2.6em;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    
    .add-to-cart-btn {
      margin-top: auto;
    }
  </style>

  <!-- Compare Bar -->
  <div class="compare-bar" id="compare-bar">
    <div class="compare-items" id="compare-items"></div>
    <div style="display: flex; gap: 12px;">
      <button class="clear-compare" onclick="clearComparison()" style="background: transparent; color: var(--text-secondary); border: 1px solid rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 6px; cursor: pointer;">Clear All</button>
      <button class="compare-btn" onclick="openComparison()" style="background: var(--premium-gold); color: #000; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;">Compare Products</button>
    </div>
  </div>

  <!-- Comparison Modal -->
  <div class="comparison-modal" id="comparison-modal">
    <div class="comparison-content">
      <div class="comparison-header">
        <h2 style="color: var(--premium-gold); margin: 0;">üìä Product Comparison</h2>
        <button class="close-comparison" onclick="closeComparison()" style="background: none; border: none; color: var(--text-color); font-size: 2rem; cursor: pointer;">√ó</button>
      </div>
      <div style="overflow-x: auto;">
        <table class="comparison-table" id="comparison-table">
          <!-- Comparison table will be generated here -->
        </table>
      </div>
    </div>
  </div>

  <!-- COPY ALL MODALS FROM YOUR MAIN PAGE -->
  <!-- Login Modal -->
  <div id="login-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Sign In</h3>
        <button class="close-modal" onclick="closeModal('login-modal')">√ó</button>
      </div>
      <form class="modal-form" id="login-form">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required>
        </div>
        <button type="submit" class="form-submit">Sign In</button>
        <div class="form-switch">
          Don't have an account? <a href="#" onclick="switchModal('login-modal', 'signup-modal')">Sign Up</a>
          <br><br>
          <a href="#" onclick="resetPassword()" style="color: #ff6b35;">Reset Password</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Signup Modal -->
  <div id="signup-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Create Account</h3>
        <button class="close-modal" onclick="closeModal('signup-modal')">√ó</button>
      </div>
      <form class="modal-form" id="signup-form">
        <div class="form-group">
          <label for="signup-name">Full Name</label>
          <input type="text" id="signup-name" required>
        </div>
        <div class="form-group">
          <label for="signup-email">Email</label>
          <input type="email" id="signup-email" required>
        </div>
        <div class="form-group">
          <label for="signup-password">Password</label>
          <input type="password" id="signup-password" required minlength="6">
        </div>
        <div class="form-group">
          <label for="signup-confirm">Confirm Password</label>
          <input type="password" id="signup-confirm" required minlength="6">
        </div>
        <button type="submit" class="form-submit">Create Account</button>
        <div class="form-switch">
          Already have an account? <a href="#" onclick="switchModal('signup-modal', 'login-modal')">Sign In</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Upload Video</h3>
        <button class="close-modal" onclick="closeModal('upload-modal')">√ó</button>
      </div>
      <form class="modal-form" id="upload-form">
        <div class="form-group">
          <label for="video-title">Title</label>
          <input type="text" id="video-title" required>
        </div>
        <div class="form-group">
          <label for="video-description">Description</label>
          <textarea id="video-description" rows="4" required></textarea>
        </div>
        <div class="form-group">
          <label for="video-file">Video File</label>
          <input type="file" id="video-file" accept="video/*" required>
        </div>
        <div class="form-group">
          <label for="thumbnail-file">Thumbnail</label>
          <input type="file" id="thumbnail-file" accept="image/*" required>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="video-publish" checked> Publish immediately
          </label>
        </div>
        <button type="submit" class="form-submit">Upload</button>
      </form>
    </div>
  </div>

  <!-- Cart Modal -->
  <div id="cart-modal" class="modal">
    <div class="modal-content cart-modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Shopping Cart</h3>
        <button class="close-modal" onclick="closeModal('cart-modal')">√ó</button>
      </div>
      
      <div class="cart-modal-body">
        <div id="cart-items-container">
          <!-- Cart items will be populated by JavaScript -->
        </div>
        
        <div class="cart-summary" id="cart-summary" style="display: none;">
          <div class="summary-row">
            <span>Subtotal:</span>
            <span id="cart-subtotal">$0.00</span>
          </div>
          <div class="summary-row" id="bulk-discount-row" style="display: none;">
            <span>Bulk Discount:</span>
            <span id="bulk-discount" style="color: #4CAF50;">-$0.00</span>
          </div>
          <div class="summary-row">
            <span>Shipping:</span>
            <span id="cart-shipping">FREE</span>
          </div>
          <div class="summary-row">
            <span>Tax (est.):</span>
            <span id="cart-tax">$0.00</span>
          </div>
          <div class="summary-row total-row">
            <span><strong>Total:</strong></span>
            <span id="cart-total"><strong>$0.00</strong></span>
          </div>
        </div>
        
        <div class="cart-actions" id="cart-actions" style="display: none;">
          <button class="cart-action-btn secondary" onclick="clearCart()">
            üóëÔ∏è Clear Cart
          </button>
          <button class="cart-action-btn primary" onclick="proceedToCheckout()" id="checkout-btn">
            üõí Proceed to Checkout
          </button>
        </div>
        
        <div class="empty-cart" id="empty-cart">
          <div style="text-align: center; padding: 40px;">
            <div style="font-size: 3rem; margin-bottom: 16px;">üõí</div>
            <h4>Your cart is empty</h4>
            <p>Add some products to get started!</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkout-modal" class="modal">
    <div class="modal-content checkout-modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Secure Checkout</h3>
        <button class="close-modal" onclick="closeModal('checkout-modal')">√ó</button>
      </div>
      
      <div class="checkout-modal-body">
        <!-- Customer Information -->
        <div class="checkout-section">
          <h4>Contact Information</h4>
          <div class="form-group">
            <label for="checkout-email">Email *</label>
            <input type="email" id="checkout-email" required placeholder="your@email.com">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="checkout-first-name">First Name *</label>
              <input type="text" id="checkout-first-name" required>
            </div>
            <div class="form-group">
              <label for="checkout-last-name">Last Name *</label>
              <input type="text" id="checkout-last-name" required>
            </div>
          </div>
          <div class="form-group">
            <label for="checkout-phone">Phone (optional)</label>
            <input type="tel" id="checkout-phone" placeholder="+1 (555) 123-4567">
          </div>
        </div>
        
        <!-- Shipping Address -->
        <div class="checkout-section">
          <h4>Shipping Address</h4>
          <div class="form-group">
            <label for="checkout-address1">Address Line 1 *</label>
            <input type="text" id="checkout-address1" required placeholder="123 Main Street">
          </div>
          <div class="form-group">
            <label for="checkout-address2">Address Line 2 (optional)</label>
            <input type="text" id="checkout-address2" placeholder="Apt 4B">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="checkout-city">City *</label>
              <input type="text" id="checkout-city" required>
            </div>
            <div class="form-group">
              <label for="checkout-state">State *</label>
              <input type="text" id="checkout-state" required placeholder="CA">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="checkout-zip">ZIP Code *</label>
              <input type="text" id="checkout-zip" required placeholder="90210">
            </div>
            <div class="form-group">
              <label for="checkout-country">Country *</label>
              <select id="checkout-country" required>
                <option value="US">United States</option>
                <option value="CA">Canada</option>
                <option value="GB">United Kingdom</option>
                <option value="AU">Australia</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Order Summary -->
        <div class="checkout-section">
          <h4>Order Summary</h4>
          <div id="checkout-items-list">
            <!-- Items will be populated by JavaScript -->
          </div>
          <div class="checkout-summary">
            <div class="summary-row">
              <span>Subtotal:</span>
              <span id="checkout-subtotal">$0.00</span>
            </div>
            <div class="summary-row">
              <span>Shipping:</span>
              <span id="checkout-shipping">FREE</span>
            </div>
            <div class="summary-row">
              <span>Tax (est.):</span>
              <span id="checkout-tax">$0.00</span>
            </div>
            <div class="summary-row total-row">
              <span><strong>Total:</strong></span>
              <span id="checkout-total"><strong>$0.00</strong></span>
            </div>
          </div>
        </div>
        
        <!-- Checkout Actions -->
        <div class="checkout-actions">
          <button class="checkout-action-btn secondary" onclick="goBackToCart()">
            ‚Üê Back to Cart
          </button>
          <button class="checkout-action-btn primary" onclick="createStripeSession()" id="stripe-checkout-btn">
            üîí Pay Securely with Stripe
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div id="product-modal" class="modal">
    <div class="modal-content product-modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="product-modal-title">Product Details</h3>
        <button class="close-modal" onclick="closeProductModal()">√ó</button>
      </div>
      
      <div class="product-modal-body">
        <!-- Product Image Gallery -->
        <div class="product-modal-images">
          <div class="main-image-container">
            <img id="product-modal-main-img" src="" alt="" style="width: 100%; height: 850px; object-fit: contain; border-radius: 8px; max-width: none;">
          </div>
          <div class="thumbnail-images" id="product-thumbnails" style="display: none;">
            <!-- Thumbnails will be populated by JS -->
          </div>
        </div>
        
        <div class="product-modal-info">
          <div class="product-modal-price" id="product-modal-price">$0.00</div>
          
          <!-- Enhanced Product Description -->
          <div class="product-modal-description" id="product-modal-description">
            Loading product details...
          </div>
          
          <!-- Product Variants Selection -->
          <div class="product-variants" id="product-variants" style="display: none; margin: 16px 0; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 8px;">
            <h4 style="margin-bottom: 12px; color: var(--premium-gold);">Available Options:</h4>
            <div class="variant-selectors" id="variant-selectors">
              <!-- Size selector -->
              <div class="variant-group" id="size-selector-group" style="display: none; margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Size:</label>
                <select id="size-selector" onchange="updateSelectedVariant()" style="width: 100%; padding: 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: #000000; color: var(--text-color); font-size: 1rem;">
                  <option value="">Select Size</option>
                </select>
              </div>
              
              <!-- Color selector -->
              <div class="variant-group" id="color-selector-group" style="display: none; margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Color:</label>
                <select id="color-selector" onchange="updateSelectedVariant()" style="width: 100%; padding: 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: #000000; color: var(--text-color); font-size: 1rem;">
                  <option value="">Select Color</option>
                </select>
              </div>
              
              <!-- Style selector (for CJ variants) -->
              <div class="variant-group" id="style-selector-group" style="display: none; margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Style:</label>
                <select id="style-selector" onchange="updateSelectedVariant()" style="width: 100%; padding: 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: #000000; color: var(--text-color); font-size: 1rem;">
                    <option value="">Select Style</option>
                </select>
              </div>
              
              <!-- Selected variant price -->
              <div class="variant-price" id="variant-price" style="display: none; margin-top: 12px; font-weight: bold; color: var(--premium-gold);">
                Selected Option: $<span id="variant-price-value">0.00</span>
              </div>
            </div>
          </div>
          
          <!-- Product Features (if available) -->
          <div class="product-features" id="product-features" style="display: none;">
            <h4>Key Features:</h4>
            <ul id="product-features-list"></ul>
          </div>
          
          <!-- Customer-Facing Details Only -->
          <div class="product-modal-details">
            <div class="detail-row">
              <span class="detail-label">Trending Score:</span>
              <span class="detail-value" id="product-modal-trending">üî• 0</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Discovered on:</span>
              <span class="detail-value" id="product-modal-subreddit">r/loading</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Shipping:</span>
              <span class="detail-value" id="product-modal-shipping">Fast & Free</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Availability:</span>
              <span class="detail-value" id="product-modal-stock">In Stock</span>
            </div>
          </div>
          
          <!-- Updated Action Buttons -->
          <div class="product-modal-actions" style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
            <button class="product-action-btn primary" onclick="addToCartFromModal()" id="add-to-cart-modal-btn" style="flex: 1; min-width: 140px; padding: 12px 16px; border-radius: 8px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, var(--premium-gold), var(--warm-bronze)); color: #000; transition: all 0.3s ease;">
              üõí Add to Cart
            </button>
            <button class="product-action-btn primary" onclick="addToCartAndCheckout()" id="buy-now-btn" style="flex: 1; min-width: 140px; padding: 12px 16px; border-radius: 8px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, var(--premium-gold), var(--warm-bronze));; color: #000; transition: all 0.3s ease;">
              üöÄ Buy Now
            </button>
            <button class="product-action-btn secondary" onclick="addToWishlist()" id="wishlist-btn" style="flex: 1; min-width: 140px; padding: 12px 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: var(--text-color); cursor: pointer; transition: all 0.3s ease;">
              ‚ù§Ô∏è Save for Later
            </button>
          </div>
          <!-- Product Reviews Section - CLICKABLE -->
          <div class="product-reviews-section" id="product-reviews-section" style="display: none; margin: 16px 0; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 8px; cursor: pointer;" onclick="openReviewsModal()">
            <h4 style="margin-bottom: 12px; color: var(--premium-gold);">Customer Reviews:</h4>
            <div id="product-reviews-preview">
              <!-- Preview will be populated by JavaScript -->
            </div>
            <div style="margin-top: 8px; color: #888; font-size: 0.9rem;">
              üí¨ Click to see all reviews
            </div>
          </div>

          <!-- REVIEWS POPUP MODAL -->
          <div id="reviews-modal" class="modal" style="position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 10000 !important; align-items: center !important; justify-content: center !important; background: rgba(0,0,0,0.85) !important;">
            <div class="modal-content" style="max-width: 600px; max-height: 80vh;">
              <div class="modal-header">
                <h3 class="modal-title" id="reviews-modal-title">Customer Reviews</h3>
                <button class="close-modal" onclick="closeModal('reviews-modal')">√ó</button>
              </div>
              <div class="modal-body" style="max-height: 500px; overflow-y: auto; padding: 20px;">
                <div id="reviews-modal-content">
                  <!-- All reviews will be populated here -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay"></div>
  
  <script>
    // REAL SHOP PAGE IMPLEMENTATION - Uses your actual API routes
    
    // Global variables - COPY FROM YOUR MAIN PAGE
    let allProducts = [];
    let filteredProducts = [];
    let currentProducts = []; // For compatibility with existing functions
    let currentSort = 'trending';
    let cart = JSON.parse(localStorage.getItem('videoshop-cart') || '[]');
    let compareList = [];
    const MAX_COMPARE = 3;
    let stripe = null;
    
    // REAL BULK DISCOUNT TIERS (as discussed)
    const BULK_DISCOUNTS = {
      3: 0.05,   // 5% off each item when buying 3+
      6: 0.10,   // 10% off each item when buying 6+
      9: 0.15,   // 15% off each item when buying 9+
      12: 0.20,  // 20% off each item when buying 12+
      15: 0.25   // 25% off each item when buying 15+
    };

      // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      
      // Initialize Stripe
      stripe = Stripe('{{STRIPE_PUBLISHABLE_KEY}}');
      
      // Add cart icon to header
      addCartIconToHeader();
      
      // Load products and setup
      loadAllProducts();
      updateBulkDiscount();
      updateCartCount();
      
      // Check admin status
      setTimeout(() => {
        checkAdminStatus();
      }, 2000);
    });

    // Add cart icon to header - COPIED FROM YOUR MAIN PAGE
    function addCartIconToHeader() {
      const userActions = document.querySelector('.user-actions');
      if (userActions && !document.getElementById('cart-btn')) {
        const cartIcon = document.createElement('button');
        cartIcon.id = 'cart-btn';
        cartIcon.innerHTML = `üõí Cart (<span id="cart-count">0</span>)`;
        cartIcon.onclick = openCart;
        cartIcon.style.cssText = `
          background: var(--cream-panel);
          border: 1px solid rgba(0, 0, 0, 0.08);
          color: #1a1a1a;
          cursor: pointer;
          font-size: 0.95rem;
          font-weight: 600;
          padding: 11px 18px;
          border-radius: 24px;
          margin-right: 16px;
          transition: all 0.3s ease;
        `;
        userActions.insertBefore(cartIcon, userActions.firstChild);
      }
    }
    
    // Load products from your REAL API
    async function loadAllProducts() {
      try {
        console.log('üõí Loading products from real API...');
        
        const response = await fetch('/api/automation/products?limit=50');
        const data = await response.json();
        
        if (data.success && data.products) {
          allProducts = data.products;
          currentProducts = data.products; // For compatibility
          filteredProducts = [...allProducts];
          
          console.log(`‚úÖ Loaded ${allProducts.length} real products`);
          
          document.getElementById('product-count').textContent = `${allProducts.length} items`;
          
          renderAllProducts();
          
        } else {
          console.error('‚ùå Failed to load products');
          showError('Failed to load products from server');
        }
      } catch (error) {
        console.error('üí• Error loading products:', error);
        showError('Error connecting to server');
      }
    }
    
    // Render products with compare checkboxes
    function renderAllProducts() {
      const container = document.getElementById('all-products');
      
      if (filteredProducts.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No products found</div>';
        return;
      }
      
      const html = filteredProducts.map(product => `
        <div class="product-card" style="position: relative;">
          <!-- Compare Checkbox -->
          <div class="compare-checkbox-container">
            <input type="checkbox" 
                   class="compare-checkbox" 
                   data-product-id="${product.id}"
                   onchange="toggleCompare('${product.id}')"
                   ${compareList.includes(product.id) ? 'checked' : ''}>
          </div>
          
          <div class="product-image" onclick="openProductModal('${product.id}')" style="cursor: pointer;">
            <img src="${product.imageUrl || 'https://via.placeholder.com/250x200?text=Product'}" 
                 alt="${product.name}" 
                 style="width: 100%; height: 200px; object-fit: cover;" 
                 onerror="this.src='https://via.placeholder.com/250x200?text=Product'">
          </div>
          
          <div class="product-info">
            <div class="product-name" onclick="openProductModal('${product.id}')" style="cursor: pointer;">${product.name}</div>
            <div class="product-price">$${parseFloat(product.price).toFixed(2)}</div>
            <div class="product-rating">
              üî• ${product.trendingScore || 0} | ${product.subreddit || 'N/A'}
            </div>
            <div class="product-supplier" style="font-size: 0.8rem; color: #aaa; margin-top: 4px;">
              ${getShippingText(product.supplier)}
            </div>
            
            <button class="add-to-cart-btn" onclick="addToCart('${product.id}')" style="
              width: 100%; 
              margin-top: 8px; 
              padding: 8px; 
              background: var(--premium-gold); 
              color: #000; 
              border: none; 
              border-radius: 4px; 
              font-weight: 600; 
              cursor: pointer;
            ">
              üõí Add to Cart
            </button>
          </div>
        </div>
      `).join('');
      
      container.innerHTML = html;
    }
    
    // Get shipping text based on supplier
    function getShippingText(supplier) {
      switch (supplier) {
        case 'spocket': return '‚ö° Fast US/EU Shipping (2-7 days)';
        case 'cjdropshipping': return 'üåé Global Shipping (7-15 days)';
        default: return 'üì¶ Standard Shipping';
      }
    }
    
    // Search products
    function searchProducts() {
      const query = document.getElementById('search-input').value.toLowerCase().trim();
      
      if (!query) {
        filteredProducts = [...allProducts];
      } else {
        filteredProducts = allProducts.filter(product => 
          product.name.toLowerCase().includes(query) ||
          (product.description && product.description.toLowerCase().includes(query))
        );
      }
      
      applyFilters();
    }
    
    // Apply filters
    function applyFilters() {
      const priceRange = document.getElementById('price-filter').value;
      const supplier = document.getElementById('supplier-filter').value;
      
      let filtered = [...allProducts];
      
      // Apply search first if there's a query
      const query = document.getElementById('search-input').value.toLowerCase().trim();
      if (query) {
        filtered = filtered.filter(product => 
          product.name.toLowerCase().includes(query) ||
          (product.description && product.description.toLowerCase().includes(query))
        );
      }
      
      // Price filter
      if (priceRange) {
        filtered = filtered.filter(product => {
          const price = parseFloat(product.price);
          switch (priceRange) {
            case '0-25': return price < 25;
            case '25-50': return price >= 25 && price < 50;
            case '50-100': return price >= 50 && price < 100;
            case '100+': return price >= 100;
            default: return true;
          }
        });
      }
      
      // Supplier filter
      if (supplier) {
        filtered = filtered.filter(product => product.supplier === supplier);
      }
      
      filteredProducts = filtered;
      sortProductsArray();
      renderAllProducts();
      
      document.getElementById('product-count').textContent = `${filteredProducts.length} items`;
    }
    
    // Sort products
    function sortProducts(sortType) {
      // Update active button
      document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      currentSort = sortType;
      sortProductsArray();
      renderAllProducts();
    }
    
    function sortProductsArray() {
      switch (currentSort) {
        case 'trending':
          filteredProducts.sort((a, b) => (b.trendingScore || 0) - (a.trendingScore || 0));
          break;
        case 'price-low':
          filteredProducts.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
          break;
        case 'price-high':
          filteredProducts.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
          break;
        case 'newest':
          filteredProducts.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
          break;
      }
    }
    
    // BULK DISCOUNT CALCULATOR
    function updateBulkDiscount() {
      const quantity = parseInt(document.getElementById('bulk-quantity').value);
      const basePrice = parseFloat(document.getElementById('base-price').value);
      
      document.getElementById('quantity-display').textContent = quantity;
      
      const discountRate = getBulkDiscountRate(quantity);
      const discountAmount = basePrice * discountRate;
      const finalPrice = basePrice - discountAmount;
      const totalPrice = finalPrice * quantity;
      const totalSavings = discountAmount * quantity;
      
      let displayText = `${quantity} item${quantity > 1 ? 's' : ''} = $${totalPrice.toFixed(2)}`;
      
      if (discountRate > 0) {
        displayText += ` (${(discountRate * 100)}% off - Save $${totalSavings.toFixed(2)}!)`;
      } else {
        displayText += ` (No discount)`;
      }
      
      document.getElementById('discount-display').textContent = displayText;
    }
    
    function getBulkDiscountRate(totalQuantity) {
      let discountRate = 0;
      for (const [minQty, rate] of Object.entries(BULK_DISCOUNTS)) {
        if (totalQuantity >= parseInt(minQty)) {
          discountRate = rate;
        }
      }
      return discountRate;
    }
    
    // PRODUCT COMPARISON FUNCTIONS
    function toggleCompare(productId) {
      const checkbox = document.querySelector(`[data-product-id="${productId}"]`);
      
      if (checkbox.checked) {
        if (compareList.length >= MAX_COMPARE) {
          checkbox.checked = false;
          alert(`You can only compare ${MAX_COMPARE} products at once`);
          return;
        }
        compareList.push(productId);
      } else {
        compareList = compareList.filter(id => id !== productId);
      }
      
      updateCompareBar();
    }
    
    function updateCompareBar() {
      const compareBar = document.getElementById('compare-bar');
      const compareItems = document.getElementById('compare-items');
      
      if (compareList.length === 0) {
        compareBar.classList.remove('active');
        return;
      }
      
      compareBar.classList.add('active');
      
      const selectedProducts = compareList.map(id => 
        allProducts.find(p => p.id === id)
      ).filter(Boolean);
      
      compareItems.innerHTML = selectedProducts.map(product => `
        <div class="compare-item">
          <img src="${product.imageUrl || 'https://via.placeholder.com/40x40'}" alt="${product.name}">
          <span>${product.name.substring(0, 15)}${product.name.length > 15 ? '...' : ''}</span>
          <button onclick="removeFromCompare('${product.id}')" style="background: none; border: none; color: #ff6b6b; cursor: pointer; margin-left: 8px;">√ó</button>
        </div>
      `).join('');
    }
    
    function removeFromCompare(productId) {
      compareList = compareList.filter(id => id !== productId);
      
      const checkbox = document.querySelector(`[data-product-id="${productId}"]`);
      if (checkbox) checkbox.checked = false;
      
      updateCompareBar();
    }
    
    function clearComparison() {
      compareList = [];
      
      // Uncheck all checkboxes
      document.querySelectorAll('.compare-checkbox').forEach(cb => {
        cb.checked = false;
      });
      
      updateCompareBar();
    }
    
    // Open comparison modal using REAL API
    async function openComparison() {
      if (compareList.length < 2) {
        alert('Please select at least 2 products to compare');
        return;
      }
      
      try {
        const response = await fetch(`/api/automation/products/compare?ids=${compareList.join(',')}`);
        const data = await response.json();
        
        if (data.success) {
          generateComparisonTable(data.products);
          document.getElementById('comparison-modal').classList.add('active');
          document.body.style.overflow = 'hidden'; // PREVENT BODY SCROLL
        } else {
          // Fallback to local comparison
          const selectedProducts = compareList.map(id => 
            allProducts.find(p => p.id === id)
          ).filter(Boolean);
          generateComparisonTable(selectedProducts);
          document.getElementById('comparison-modal').classList.add('active');
          document.body.style.overflow = 'hidden'; // PREVENT BODY SCROLL
        }
      } catch (error) {
        console.error('Comparison error:', error);
        // Fallback to local comparison
        const selectedProducts = compareList.map(id => 
          allProducts.find(p => p.id === id)
        ).filter(Boolean);
        generateComparisonTable(selectedProducts);
        document.getElementById('comparison-modal').classList.add('active');
        document.body.style.overflow = 'hidden'; // PREVENT BODY SCROLL
      }
    }

    function closeComparison() {
      document.getElementById('comparison-modal').classList.remove('active');
      document.body.style.overflow = 'auto'; // RESTORE BODY SCROLL
    }
        
    // ADD THIS TO YOUR EXISTING JavaScript - REPLACE the generateComparisonTable function:

    function generateComparisonTable(selectedProducts) {
      const table = document.getElementById('comparison-table');
      
      // Updated features - REMOVED supplier, FIXED availability
      const features = [
        { key: 'imageUrl', label: 'Product Image', type: 'image' },
        { key: 'name', label: 'Product Name', type: 'text' },
        { key: 'price', label: 'Price', type: 'price' },
        { key: 'trendingScore', label: 'Trending Score', type: 'trending' },
        { key: 'subreddit', label: 'Discovered On', type: 'text' },
        { key: 'description', label: 'Description', type: 'description' },
        { key: 'shipping', label: 'Shipping', type: 'shipping' },
        { key: 'availability', label: 'Availability', type: 'stock' }, // FIXED
        { key: 'hasVariants', label: 'Has Options', type: 'boolean' }
      ];
      
      let tableHTML = `
        <thead>
          <tr>
            <th class="feature-label">Feature</th>
            ${selectedProducts.map(product => `
              <th class="product-column">
                <img src="${product.imageUrl || 'https://via.placeholder.com/80x80'}" alt="${product.name}">
                <div>${product.name}</div>
              </th>
            `).join('')}
          </tr>
        </thead>
        <tbody>
      `;
      
      features.forEach(feature => {
        const values = selectedProducts.map(product => {
          const value = getFeatureValue(product, feature);
          return { product, value, raw: product[feature.key] };
        });
        
        const winner = findWinner(values, feature.type);
        
        tableHTML += `
      <tr>
        <td class="feature-label">${feature.label}</td>
        ${values.map((item, index) => `
          <td class="product-column">
            ${item.value}
          </td>
        `).join('')}
      </tr>
    `;
      });
      
      // Add to cart row
      tableHTML += `
        <tr style="background: rgba(255, 255, 255, 0.05);">
          <td class="feature-label"><strong>Add to Cart</strong></td>
          ${selectedProducts.map(product => `
            <td class="product-column">
              <button onclick="addToCartFromComparison('${product.id}')" style="background: var(--premium-gold); color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%;">
                üõí Add to Cart
              </button>
            </td>
          `).join('')}
        </tr>
      `;
      
      tableHTML += '</tbody>';
      table.innerHTML = tableHTML;
    }

    // ALSO UPDATE the getFeatureValue function:
    function getFeatureValue(product, feature) {
      switch (feature.type) {
        case 'image':
          return `<img src="${product.imageUrl || 'https://via.placeholder.com/60x60'}" 
                       style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">`;
        
        case 'price':
          return `$${parseFloat(product.price || 0).toFixed(2)}`;
        
        case 'trending':
          return `üî• ${product.trendingScore || 0}`;
        
        case 'description':
          const desc = product.description || 'No description available';
          return desc.length > 100 ? desc.substring(0, 97) + '...' : desc;
        
        case 'shipping':
          if (product.supplier === 'spocket') return '‚ö° Fast (2-7 days)';
          if (product.supplier === 'cjdropshipping') return 'üåé Standard (7-15 days)';
          return 'üì¶ Standard';
        
        case 'stock':
          return '‚úÖ In Stock'; // ALWAYS show in stock since these are automated products
        
        case 'boolean':
          return product[feature.key] ? '‚úÖ Yes' : '‚ùå No';
        
        default:
          return product[feature.key] || 'N/A';
      }
    }

    // Find winner for each feature
    function findWinner(values, type) {
      if (values.length < 2) return -1;
      
      switch (type) {
        case 'price':
          const prices = values.map(v => parseFloat(v.product.price || 999999));
          return prices.indexOf(Math.min(...prices));
        
        case 'trending':
          const scores = values.map(v => parseInt(v.product.trendingScore || 0));
          return scores.indexOf(Math.max(...scores));
        
        case 'shipping':
          // Spocket wins for speed
          const spocketIndex = values.findIndex(v => v.product.supplier === 'spocket');
          return spocketIndex !== -1 ? spocketIndex : -1;
        
        default:
          return -1; // No clear winner
      }
    }

    function addToCartFromComparison(productId) {
      addToCart(productId);
    }

    // COPY ALL CART FUNCTIONS FROM YOUR MAIN PAGE
    function addToCart(productId) {
      console.log('üõí Adding product to cart:', productId);
      
      const product = allProducts.find(p => p.id === productId);
      if (!product) {
        console.error('‚ùå Product not found:', productId);
        return;
      }
      
      const existingItem = cart.find(item => item.productId === productId);
      
      if (existingItem) {
        existingItem.quantity += 1;
        console.log('üì¶ Updated quantity for:', product.name);
      } else {
        cart.push({
          productId: productId,
          name: product.name,
          price: parseFloat(product.price),
          supplierPrice: parseFloat(product.supplierPrice || 0),
          imageUrl: product.imageUrl,
          supplier: product.supplier,
          quantity: 1,
          addedAt: new Date().toISOString()
        });
        console.log('‚úÖ Added new item to cart:', product.name);
      }
      
      saveCart();
      updateCartCount();
      showCartNotification(`Added ${product.name} to cart!`);
    }

    function saveCart() {
      localStorage.setItem('videoshop-cart', JSON.stringify(cart));
    }

    function updateCartCount() {
      const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
      const cartCountElement = document.getElementById('cart-count');
      if (cartCountElement) {
        cartCountElement.textContent = cartCount;
      }
    }

    function showCartNotification(message) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: var(--premium-gold);
        color: #000;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 3000);
    }

    // COPY ALL MODAL FUNCTIONS FROM YOUR MAIN PAGE
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
      document.body.classList.add('modal-open');
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      document.body.classList.remove('modal-open');
    }
    
    function switchModal(closeId, openId) {
      closeModal(closeId);
      openModal(openId);
    }

    function openCart() {
      renderCart();
      openModal('cart-modal');
    }

    function renderCart() {
      const container = document.getElementById('cart-items-container');
      const summary = document.getElementById('cart-summary');
      const actions = document.getElementById('cart-actions');
      const emptyCart = document.getElementById('empty-cart');
      
      if (cart.length === 0) {
        container.innerHTML = '';
        summary.style.display = 'none';
        actions.style.display = 'none';
        emptyCart.style.display = 'block';
        return;
      }
      
      emptyCart.style.display = 'none';
      summary.style.display = 'block';
      actions.style.display = 'flex';
      
      container.innerHTML = cart.map(item => `
        <div class="cart-item" data-product-id="${item.productId}">
          <div class="cart-item-image">
            <img src="${item.imageUrl}" alt="${item.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">
          </div>
          <div class="cart-item-details">
            <div class="cart-item-name">${item.name}</div>
            <div class="cart-item-price">$${item.price.toFixed(2)} each</div>
          </div>
          <div class="cart-item-quantity">
            <button onclick="updateQuantity('${item.productId}', -1)" class="quantity-btn">-</button>
            <span class="quantity">${item.quantity}</span>
            <button onclick="updateQuantity('${item.productId}', 1)" class="quantity-btn">+</button>
          </div>
          <div class="cart-item-total">
            $${(item.price * item.quantity).toFixed(2)}
          </div>
          <button onclick="removeFromCart('${item.productId}')" class="remove-btn">√ó</button>
        </div>
      `).join('');
      
      updateCartSummary();
    }

    // UPDATED CART SUMMARY WITH BULK DISCOUNTS
    function updateCartSummary() {
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
      
      // Calculate bulk discount
      const bulkDiscountRate = getBulkDiscountRate(totalQuantity);
      const bulkDiscount = subtotal * bulkDiscountRate;
      const discountedSubtotal = subtotal - bulkDiscount;
      
      const shipping = discountedSubtotal > 50 ? 0 : 9.99;
      const tax = discountedSubtotal * 0.08;
      const total = discountedSubtotal + shipping + tax;
      
      // Update UI
      document.getElementById('cart-subtotal').textContent = `$${subtotal.toFixed(2)}`;
      
      // Show/hide bulk discount
      const bulkDiscountRow = document.getElementById('bulk-discount-row');
      if (bulkDiscountRate > 0) {
        bulkDiscountRow.style.display = 'flex';
        document.getElementById('bulk-discount').textContent = `-$${bulkDiscount.toFixed(2)} (${(bulkDiscountRate * 100)}% off)`;
      } else {
        bulkDiscountRow.style.display = 'none';
      }
      
      document.getElementById('cart-shipping').textContent = shipping === 0 ? 'FREE' : `$${shipping.toFixed(2)}`;
      document.getElementById('cart-tax').textContent = `$${tax.toFixed(2)}`;
      document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
    }

    function updateQuantity(productId, change) {
      const item = cart.find(item => item.productId === productId);
      if (!item) return;
      
      item.quantity += change;
      
      if (item.quantity <= 0) {
        removeFromCart(productId);
        return;
      }
      
      saveCart();
      renderCart();
      updateCartCount();
    }

    function removeFromCart(productId) {
      cart = cart.filter(item => item.productId !== productId);
      saveCart();
      renderCart();
      updateCartCount();
    }

    function clearCart() {
      if (confirm('Are you sure you want to clear your cart?')) {
        cart = [];
        saveCart();
        renderCart();
        updateCartCount();
      }
    }

    function proceedToCheckout() {
      if (cart.length === 0) {
        alert('Your cart is empty!');
        return;
      }
      
      closeModal('cart-modal');
      renderCheckout();
      openModal('checkout-modal');
    }

    function goBackToCart() {
      closeModal('checkout-modal');
      openCart();
    }

    function renderCheckout() {
      const itemsList = document.getElementById('checkout-items-list');
      
      itemsList.innerHTML = cart.map(item => `
        <div class="checkout-item">
          <img src="${item.imageUrl}" alt="${item.name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
          <div class="checkout-item-details">
            <div class="checkout-item-name">${item.name}</div>
            <div class="checkout-item-quantity">Qty: ${item.quantity}</div>
          </div>
          <div class="checkout-item-total">$${(item.price * item.quantity).toFixed(2)}</div>
        </div>
      `).join('');
      
      updateCheckoutSummary();
    }

    function updateCheckoutSummary() {
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
      
      // Calculate bulk discount for checkout
      const bulkDiscountRate = getBulkDiscountRate(totalQuantity);
      const bulkDiscount = subtotal * bulkDiscountRate;
      const discountedSubtotal = subtotal - bulkDiscount;
      
      const shipping = discountedSubtotal > 50 ? 0 : 9.99;
      const tax = discountedSubtotal * 0.08;
      const total = discountedSubtotal + shipping + tax;
      
      document.getElementById('checkout-subtotal').textContent = `$${subtotal.toFixed(2)}`;
      document.getElementById('checkout-shipping').textContent = shipping === 0 ? 'FREE' : `$${shipping.toFixed(2)}`;
      document.getElementById('checkout-tax').textContent = `$${tax.toFixed(2)}`;
      document.getElementById('checkout-total').textContent = `$${total.toFixed(2)}`;
    }

    // Stripe Checkout
    async function createStripeSession() {
      const btn = document.getElementById('stripe-checkout-btn');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Processing...';
      
      try {
        // Validate form
        const email = document.getElementById('checkout-email').value;
        const firstName = document.getElementById('checkout-first-name').value;
        const lastName = document.getElementById('checkout-last-name').value;
        const address1 = document.getElementById('checkout-address1').value;
        const city = document.getElementById('checkout-city').value;
        const state = document.getElementById('checkout-state').value;
        const zip = document.getElementById('checkout-zip').value;
        const country = document.getElementById('checkout-country').value;
        
        if (!email || !firstName || !lastName || !address1 || !city || !zip) {
          alert('Please fill in all required fields');
          btn.disabled = false;
          btn.innerHTML = 'üîí Pay Securely with Stripe';
          return;
        }
        
        // Prepare order data
        const orderData = {
          items: cart.map(item => ({
            productId: item.productId,
            quantity: item.quantity
          })),
          customer: {
            email: email,
            name: `${firstName} ${lastName}`,
            phone: document.getElementById('checkout-phone').value
          },
          shippingAddress: {
            name: `${firstName} ${lastName}`,
            line1: address1,
            line2: document.getElementById('checkout-address2').value,
            city: city,
            state: state,
            postal_code: zip,
            country: country
          }
        };
        
        console.log('üõí Creating Stripe session with data:', orderData);
        
        // Create checkout session
        const response = await fetch('/api/checkout/create-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(orderData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          console.log('‚úÖ Stripe session created:', result.sessionId);
          
          // Redirect to Stripe Checkout
          const { error } = await stripe.redirectToCheckout({
            sessionId: result.sessionId
          });
          
          if (error) {
            console.error('‚ùå Stripe redirect error:', error);
            alert('Payment setup failed. Please try again.');
          }
        } else {
          console.error('‚ùå Session creation failed:', result.error);
          alert(`Checkout failed: ${result.error}`);
        }
        
      } catch (error) {
        console.error('‚ùå Checkout error:', error);
        alert('Checkout failed. Please try again.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîí Pay Securely with Stripe';
      }
    }

    // COPY ALL PRODUCT MODAL FUNCTIONS FROM YOUR MAIN PAGE
    function openProductModal(productId) {
      console.log('üîç Opening product modal for ID:', productId);
      
      const product = allProducts.find(p => p.id === productId);
      
      if (!product) {
        console.error('‚ùå Product not found:', productId);
        return;
      }
      
      console.log('üì¶ Product found:', product);
      
      // Populate modal with product data
      document.getElementById('product-modal-title').textContent = product.name;
      
      // Main image
      const mainImg = document.getElementById('product-modal-main-img');
      mainImg.src = product.imageUrl || 'https://via.placeholder.com/400x350?text=Product';
      mainImg.alt = product.name;
      
      // Handle multiple images
      setupProductImages(product);
      
      // Setup product variants
      setupProductVariants(product);
      
      // Price
      document.getElementById('product-modal-price').textContent = `$${parseFloat(product.price).toFixed(2)}`;
      
      // Enhanced description
      const description = generateEnhancedDescription(product);
      document.getElementById('product-modal-description').innerHTML = description;
      
      // Features
      setupProductFeatures(product);
      
      // Details
      document.getElementById('product-modal-trending').textContent = `üî• ${product.trendingScore}`;
      document.getElementById('product-modal-subreddit').textContent = `${product.subreddit}`;
      document.getElementById('product-modal-shipping').textContent = getShippingInfo(product);
      document.getElementById('product-modal-stock').textContent = 'In Stock ‚úÖ';
      
      // Store current product for actions
      window.currentProduct = product;
      
      // Setup reviews section
      setupProductReviews(product);
      
      // Open the modal
      openModal('product-modal');
    }

    function closeProductModal() {
      closeModal('product-modal');
      setTimeout(() => {
        document.body.style.overflow = 'auto';
        document.documentElement.style.overflow = 'auto';
      }, 100);
    }

    function setupProductImages(product) {
      const thumbnailsContainer = document.getElementById('product-thumbnails');
      
      let images = [];
      if (product.images && Array.isArray(product.images)) {
        images = product.images;
      } else if (product.imageUrl) {
        images = [product.imageUrl];
      }
      
      if (images.length > 1) {
        thumbnailsContainer.style.display = 'flex';
        thumbnailsContainer.innerHTML = images.map((img, index) => 
          `<img src="${img}" alt="Product image ${index + 1}" 
                class="thumbnail-img ${index === 0 ? 'active' : ''}" 
                onclick="switchMainImage('${img}')"
                style="width: 60px; height: 60px; object-fit: contain; border-radius: 4px; margin: 4px; cursor: pointer; border: 2px solid ${index === 0 ? 'var(--premium-gold)' : 'transparent'};">`
        ).join('');
      } else {
        thumbnailsContainer.style.display = 'none';
      }
    }

    function switchMainImage(imageUrl) {
      document.getElementById('product-modal-main-img').src = imageUrl;
      
      document.querySelectorAll('.thumbnail-img').forEach(thumb => {
        thumb.style.border = thumb.src === imageUrl ? '2px solid var(--premium-gold)' : '2px solid transparent';
      });
    }

    function setupProductVariants(product) {
      const variantsContainer = document.getElementById('product-variants');
      const sizeGroup = document.getElementById('size-selector-group');
      const colorGroup = document.getElementById('color-selector-group');
      const styleGroup = document.getElementById('style-selector-group');
      
      // Reset all selectors
      sizeGroup.style.display = 'none';
      colorGroup.style.display = 'none';
      styleGroup.style.display = 'none';
      variantsContainer.style.display = 'none';
      
      if (!product.variants || !Array.isArray(product.variants) || product.variants.length === 0) {
        return;
      }
      
      variantsContainer.style.display = 'block';
      
      // Extract unique sizes, colors, and styles
      const sizes = [...new Set(product.variants.filter(v => v.size).map(v => v.size))];
      const colors = [...new Set(product.variants.filter(v => v.color).map(v => v.color))];
      const styles = [...new Set(product.variants.filter(v => v.name && !v.size && !v.color).map(v => v.name))];
      
      // Setup size selector
      if (sizes.length > 0) {
        const sizeSelector = document.getElementById('size-selector');
        sizeSelector.innerHTML = '<option value="">Select Size</option>' + 
          sizes.map(size => `<option value="${size}">${size}</option>`).join('');
        sizeGroup.style.display = 'block';
      }
      
      // Setup color selector
      if (colors.length > 0) {
        const colorSelector = document.getElementById('color-selector');
        colorSelector.innerHTML = '<option value="">Select Color</option>' + 
          colors.map(color => `<option value="${color}">${color}</option>`).join('');
        colorGroup.style.display = 'block';
      }
      
      // Setup style selector
      if (styles.length > 0) {
        const styleSelector = document.getElementById('style-selector');
        styleSelector.innerHTML = '<option value="">Select Style</option>' + 
          styles.map(style => `<option value="${style}">${style}</option>`).join('');
        styleGroup.style.display = 'block';
      }
      
      // Store variants for selection
      window.currentProductVariants = product.variants;
    }

    function updateSelectedVariant() {
      if (!window.currentProductVariants) return;
      
      const selectedSize = document.getElementById('size-selector')?.value || '';
      const selectedColor = document.getElementById('color-selector')?.value || '';
      const selectedStyle = document.getElementById('style-selector')?.value || '';
      
      // Find matching variant
      let matchingVariant = null;
      
      for (const variant of window.currentProductVariants) {
        const sizeMatch = !selectedSize || variant.size === selectedSize;
        const colorMatch = !selectedColor || variant.color === selectedColor;
        const styleMatch = !selectedStyle || variant.name === selectedStyle;
        
        if (sizeMatch && colorMatch && styleMatch) {
          matchingVariant = variant;
          break;
        }
      }
      
      // Update price and image if variant found
      if (matchingVariant) {
        const priceContainer = document.getElementById('variant-price');
        const priceValue = document.getElementById('variant-price-value');
        
        if (matchingVariant.price && matchingVariant.price > 0) {
          priceValue.textContent = matchingVariant.price.toFixed(2);
          priceContainer.style.display = 'block';
        }
        
        // Update main image if variant has specific image
        if (matchingVariant.image) {
          document.getElementById('product-modal-main-img').src = matchingVariant.image;
        }
        
        // Store selected variant
        window.selectedVariant = matchingVariant;
      } else {
        document.getElementById('variant-price').style.display = 'none';
        window.selectedVariant = null;
      }
    }

    function generateEnhancedDescription(product) {
      const isRealCJ = product.supplier === 'cjdropshipping';
      const isSpocket = product.supplier === 'spocket';
      const baseDescription = product.description || `High-quality ${product.name} with excellent customer reviews.`;
      
      let enhancedDesc = baseDescription;
      
      if (isRealCJ) {
        enhancedDesc += `<br><br><strong>‚úÖ Quality Verified:</strong> Direct from manufacturer with quality guarantee.`;
        enhancedDesc += `<br><strong>üåé Global Shipping:</strong> Fast delivery worldwide from CJ warehouses.`;
      } else if (isSpocket) {
        enhancedDesc += `<br><br><strong>‚ö° Lightning Fast:</strong> 2-7 day shipping from US/EU suppliers.`;
        enhancedDesc += `<br><strong>üá∫üá∏ Premium Quality:</strong> No Chinese packaging, professional service.`;
      } else {
        enhancedDesc += `<br><br><strong>‚ö° Prime Eligible:</strong> Fast, free shipping.`;
        enhancedDesc += `<br><strong>‚≠ê Highly Rated:</strong> Thousands of verified customer reviews.`;
      }
      
      return enhancedDesc;
    }

    function setupProductFeatures(product) {
      const featuresContainer = document.getElementById('product-features');
      const featuresList = document.getElementById('product-features-list');
      
      const features = generateProductFeatures(product.name, product.supplier);
      
      if (features.length > 0) {
        featuresList.innerHTML = features.map(feature => `<li>${feature}</li>`).join('');
        featuresContainer.style.display = 'block';
      } else {
        featuresContainer.style.display = 'none';
      }
    }

    function generateProductFeatures(productName, supplier) {
      const name = productName.toLowerCase();
      let features = [];
      
      if (name.includes('speaker') || name.includes('bluetooth')) {
        features = [
          'Wireless Bluetooth 5.0 connectivity',
          'High-quality stereo sound',
          'Long-lasting battery life',
          'Water-resistant design',
          'Easy pairing with all devices'
        ];
      } else if (name.includes('watch') || name.includes('omega')) {
        features = [
          'Precision quartz movement',
          'Water-resistant to 50m',
          'Scratch-resistant crystal',
          'Comfortable leather strap',
          'Classic elegant design'
        ];
      } else if (name.includes('shorts') || name.includes('workwear')) {
        features = [
          'Durable cotton blend fabric',
          'Multiple functional pockets',
          'Comfortable loose fit',
          'Reinforced stress points',
          'Machine washable'
        ];
      } else if (name.includes('dog') || name.includes('pet')) {
        features = [
          'Made from safe, non-toxic materials',
          'Durable construction for active pets',
          'Easy to clean and maintain',
          'Suitable for all dog sizes',
          'Recommended by veterinarians'
        ];
      } else {
        features = [
          'Premium quality construction',
          'Easy to use and maintain',
          'Excellent value for money',
          'Fast and reliable performance',
          'Backed by customer satisfaction guarantee'
        ];
      }
      
      return features.slice(0, 4);
    }

    function getShippingInfo(product) {
      if (product.supplier === 'cjdropshipping') {
        return 'üåé Global Shipping (7-15 days)';
      } else if (product.supplier === 'spocket') {
        return '‚ö° US/EU Shipping (2-7 days)';
      } else {
        return 'üì¶ Standard Shipping';
      }
    }

    function addToCartFromModal() {
      if (window.currentProduct) {
        addToCart(window.currentProduct.id);
        closeProductModal();
      }
    }

    function addToCartAndCheckout() {
      if (window.currentProduct) {
        addToCart(window.currentProduct.id);
        closeProductModal();
        setTimeout(() => {
          openCart();
        }, 300);
      }
    }

    function addToWishlist() {
      if (window.currentProduct) {
        console.log('‚ù§Ô∏è Adding to wishlist:', window.currentProduct.name);
        
        let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
        
        const alreadyExists = wishlist.some(item => item.id === window.currentProduct.id);
        
        if (!alreadyExists) {
          wishlist.push({
            id: window.currentProduct.id,
            name: window.currentProduct.name,
            price: window.currentProduct.price,
            imageUrl: window.currentProduct.imageUrl,
            addedAt: new Date().toISOString()
          });
          
          localStorage.setItem('wishlist', JSON.stringify(wishlist));
          
          const btn = document.getElementById('wishlist-btn');
          const originalText = btn.innerHTML;
          btn.innerHTML = '‚úÖ Saved!';
          btn.style.background = 'rgba(76, 175, 80, 0.2)';
          
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = '';
          }, 2000);
          
          console.log('‚úÖ Added to wishlist successfully');
        } else {
          alert('This item is already in your wishlist!');
        }
      }
    }

    // COPY ALL AUTHENTICATION FUNCTIONS FROM YOUR MAIN PAGE
    document.getElementById('login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          
          const signInBtn = document.querySelector('.sign-in');
          signInBtn.textContent = `Welcome, ${data.user.name}`;
          signInBtn.onclick = signOut;
          closeModal('login-modal');
          
          console.log('‚úÖ Login successful:', data.user);
          
          if (data.user.isAdmin) {
            setTimeout(() => {
              showAdminControls();
            }, 500);
          }
        } else {
          alert('Login failed: ' + (data.errors?.[0]?.msg || 'Unknown error'));
        }
      } catch (error) {
        console.error('Login error:', error);
        alert('Login failed. Please try again.');
      }
    });

    document.getElementById('signup-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('signup-name').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const confirmPassword = document.getElementById('signup-confirm').value;
      
      if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }
      
      try {
        const response = await fetch('/api/auth/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, email, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          
          document.querySelector('.sign-in').textContent = `Welcome, ${data.user.name}`;
          closeModal('signup-modal');
          
          console.log('‚úÖ Signup successful:', data.user);
        } else {
          alert('Signup failed: ' + (data.errors?.[0]?.msg || 'Unknown error'));
        }
      } catch (error) {
        console.error('Signup error:', error);
        alert('Signup failed. Please try again.');
      }
    });

    function resetPassword() {
      const email = prompt('Enter your email address to receive a reset link:');
      if (!email) return;
      
      fetch('/api/auth/forgot-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Password reset link sent to your email! Check your inbox.');
          closeModal('login-modal');
        } else {
          alert('Reset failed: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Reset error:', error);
        alert('Reset failed. Please try again.');
      });
    }

    function signOut() {
      if (confirm('Are you sure you want to sign out?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        localStorage.removeItem('videoshop-cart');
        localStorage.removeItem('wishlist');
        
        document.querySelector('.sign-in').textContent = 'Sign In';
        document.querySelector('.sign-in').onclick = () => openModal('login-modal');
        
        const adminBadge = document.querySelector('.admin-badge');
        if (adminBadge) {
          adminBadge.remove();
        }
        
        document.querySelectorAll('.delete-btn, .delete-image-btn, .delete-main-image-btn').forEach(btn => {
          btn.remove();
        });
        
        cart = [];
        updateCartCount();
        
        alert('You have been signed out successfully');
      }
    }

    // COPY ALL ADMIN FUNCTIONS FROM YOUR MAIN PAGE
    async function checkAdminStatus() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      if (user.isAdmin) {
        console.log('‚úÖ ADMIN ACCESS GRANTED');
        showAdminControls();
      }
    }

    function showAdminControls() {
      console.log('üöÄ Showing admin controls...');
      
      const userActions = document.querySelector('.user-actions');
      if (userActions && !document.querySelector('.admin-badge')) {
        const adminBadge = document.createElement('span');
        adminBadge.className = 'admin-badge';
        adminBadge.innerHTML = 'üëë ADMIN';
        adminBadge.style.cssText = `
          background: #ff0000;
          color: white;
          padding: 2px 6px;
          border-radius: 4px;
          font-size: 0.7rem;
          font-weight: bold;
          margin-right: 4px;
        `;
        userActions.insertBefore(adminBadge, userActions.firstChild);
      }
      
      setTimeout(() => {
        addDeleteButtonsToProducts();
      }, 1000);
    }

    function addDeleteButtonsToProducts() {
      console.log('üóëÔ∏è Adding delete buttons to products...');
      
      document.querySelectorAll('.product-card').forEach((card, index) => {
        const product = filteredProducts[index];
        if (!product || card.querySelector('.delete-btn')) return;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'üóëÔ∏è';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteProduct(product.id);
        };
        deleteBtn.style.cssText = `
          position: absolute;
          top: 8px;
          right: 8px;
          background: #ff0000;
          color: white;
          border: none;
          border-radius: 50%;
          width: 32px;
          height: 32px;
          cursor: pointer;
          font-size: 16px;
          z-index: 10;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        `;
        card.appendChild(deleteBtn);
      });
    }

    async function deleteProduct(productId) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      
      const token = localStorage.getItem('token');
      
      try {
        const response = await fetch(`/api/automation/products/${productId}`, {
          method: 'DELETE',
          headers: {
            'x-auth-token': token
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('Product deleted successfully!');
          location.reload();
        } else {
          alert('Failed to delete product: ' + data.error);
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete product');
      }
    }
    function cleanReviewData(reviews) {
     return reviews
       .filter(review => {
         // Filter out reviews that contain JavaScript/CSS garbage
         const comment = review.comment || '';
         
         // Skip reviews with JavaScript artifacts
         if (comment.includes('function(') || 
             comment.includes('P.when(') || 
             comment.includes('.execute(') ||
             comment.includes('A.toggleExpander') ||
             comment.includes('review-text-read-more') ||
             comment.includes('focus-visible') ||
             comment.includes('outl') ||
             comment.length < 20) {
           return false;
         }
         
         return true;
       })
       .map(review => ({
         ...review,
         // Clean the date format
         date: review.date ? cleanReviewDate(review.date) : null,
         // Clean the reviewer name
         reviewer: review.reviewer === 'Amazon Customer' ? 'Anonymous Customer' : review.reviewer
       }));
    }

    function cleanReviewDate(dateString) {
      if (!dateString) return null;
      
      // Remove the T17:00:00.000Z timezone stuff
      if (dateString.includes('T') && dateString.includes('.000Z')) {
        const cleanDate = dateString.split('T')[0]; // Get just the date part
        try {
          const date = new Date(cleanDate);
          return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          });
        } catch (error) {
          return dateString; // Return original if parsing fails
        }
      }
      
      // If it's already a clean date string, return as is
      return dateString;
    }

    function setupProductReviews(product) {
      const reviewsSection = document.getElementById('product-reviews-section');
      const reviewsPreview = document.getElementById('product-reviews-preview');
      
      if (product.reviewsData && product.reviewsData.totalReviews > 0) {
        reviewsSection.style.display = 'block';
        
        // Show preview WITHOUT exact count
        const previewText = product.reviewsData.totalReviews > 8 ? `reviews available` : `${product.reviewsData.totalReviews} reviews`;
        
        reviewsPreview.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px;">
            <div>
              <span style="color: #ffd700; font-size: 1.2rem;">‚≠ê ${product.reviewsData.overallRating}</span>
              <span style="margin-left: 8px; color: #888;">(${previewText})</span>
            </div>
            <div style="flex: 1; color: #aaa; font-size: 0.9rem;">
              "${product.reviewsData.reviews.find(r => r.comment && !r.comment.includes('function') && r.comment.length > 20)?.comment?.substring(0, 80) || 'Verified customer reviews'}..."
            </div>
          </div>
        `;
        
        // Store reviews for modal
        window.currentProductReviews = product.reviewsData;
      } else {
        reviewsSection.style.display = 'none';
      }
    }

    function openReviewsModal() {
      if (!window.currentProductReviews) return;
      
      const reviews = window.currentProductReviews;
      const cleanedReviews = cleanReviewData(reviews.reviews);
      const modalTitle = document.getElementById('reviews-modal-title');
      const modalContent = document.getElementById('reviews-modal-content');
      
      modalTitle.textContent = 'Customer Reviews';
      
      const reviewsHTML = `
        <div style="margin-bottom: 20px; text-align: center;">
          <div style="font-size: 2rem; color: #ffd700; margin-bottom: 8px;">‚≠ê ${reviews.overallRating}</div>
          <div style="color: #888;">verified reviews from customers</div>
        </div>
        
        <div class="reviews-list">
          ${cleanedReviews.map((review, index) => `
            <div class="review-item" style="margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="color: #ffd700;">${'‚≠ê'.repeat(review.rating)}</span>
                <span style="font-weight: bold; color: var(--text-color);">${review.reviewer}</span>
                ${review.verified ? '<span style="color: #4CAF50; font-size: 0.8rem;">‚úÖ Verified</span>' : ''}
              </div>
              <p style="margin: 0; line-height: 1.5; color: #ddd;">${review.comment}</p>
              ${review.date ? `<div style="font-size: 0.8rem; color: #888; margin-top: 8px;">${review.date}</div>` : ''}
              ${review.helpful > 0 ? `<div style="font-size: 0.8rem; color: #888; margin-top: 4px;">üëç ${review.helpful} found helpful</div>` : ''}
            </div>
          `).join('')}
        </div>
      `;
      
      modalContent.innerHTML = reviewsHTML;
      openModal('reviews-modal');
      
      setTimeout(() => {
        const reviewsModal = document.getElementById('reviews-modal');
        if (reviewsModal) {
          reviewsModal.scrollIntoView({ behavior: 'instant', block: 'center' });
        }
      }, 50);
    }

    function showError(message) {
      const container = document.getElementById('all-products');
      container.innerHTML = `<div style="color: red; padding: 20px; text-align: center;">ERROR: ${message}</div>`;
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modals = document.getElementsByClassName('modal');
      for (let i = 0; i < modals.length; i++) {
        if (event.target === modals[i]) {
          const modalId = modals[i].id;
          if (modalId === 'product-modal') {
            closeProductModal();
          } else {
            closeModal(modalId);
          }
        }
      }
    };

    // Close comparison modal when clicking outside
    document.getElementById('comparison-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeComparison();
      }
    }, { once: false });

  </script>
<script src="/js/main.js"></script>
<script src="/js/subtle-effect.js"></script>
</body>
</html>